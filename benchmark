#!/usr/bin/env python3
import sys, os
import argparse

HOST_TEST_SETS='/Users/jerry/work/tiobe/test_env/dataset'
HOST_UTILS='/Users/jerry/work/git/leaderboard/utils'

parser = argparse.ArgumentParser()
parser.add_argument('submission_id', type=str)
args = parser.parse_args()

print('Leaderboard: Checking Submission ... ', end='', file=sys.stderr)
d = os.path.join('zoo', args.submission_id)
assert(os.isdir(d))
assert(os.path.isfile(os.path.join(d, 'info.yml')))
assert(os.path.isfile(os.path.join(d, 'docker/Dockerfile')))
assert(os.path.isfile(os.path.join(d, 'mbi')))
print('Done.', file=sys.stderr)

# build docker image
docker_context=os.path.join('zoo', args.submission_id, 'docker')
docker_file=os.path.join(docker_context, 'Dockerfile')
image=F'speechio/leaderboard:{args.submission_id}'
cmd = F'docker build -f {docker_file} -t {image} {docker_context}'
print(cmd, file=sys.stderr)
os.system(cmd)

# instantiate a benchmark container
opts_mount_data = F'-v {HOST_TEST_SETS}:/app/speechio/leaderboard/data:ro'
opts_mount_work_dir = F'-v {HOST_UTILS}:/app/speechio/leaderboard/utils:ro'
cmd = F'docker run {opts_mount_data} {opts_mount_work_dir} {image} /app/speechio/leaderboard/utils/benchmark.sh'
print(cmd, file=sys.stderr)
os.system(cmd)
