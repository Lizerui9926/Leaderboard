#!/usr/bin/env python3
import sys, os
import argparse
import yaml

if __name__ == '__main__':
    parser = argparse.ArgumentParser()
    parser.add_argument('--repo', choices=['public', 'private'], default='public')
    parser.add_argument('submission_dir', type=str, help='submission directory')
    args = parser.parse_args()
    print(args, file=sys.stderr)

    info_file_path = os.path.join(args.submission_dir, 'info.yaml')
    MBI_bin_path = os.path.join(args.submission_dir, 'MBI')
    print(F'Checking existence of {args.submission_dir}/{{info.yaml,MBI}}')
    for f in info_file_path, MBI_bin_path:
        assert(os.path.isfile(f))

    with open(info_file_path, 'r') as info_file:
        info = yaml.safe_load(info_file)
        key = info['submission_key']
        dst_url = F'oss://speechio-leaderboard/hub/{args.repo}/{key}/'
        upload_cmd = F'./oss -c SAFEBOX/oss.cfg cp -ur {args.submission_dir} {dst_url}'
        print(upload_cmd, file=sys.stderr)
        os.system(upload_cmd)